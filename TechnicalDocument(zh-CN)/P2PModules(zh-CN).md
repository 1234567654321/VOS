## 通信模块技术文档 (P2P Modules Technical Document)

### 通信模块简介
* 该模块需要完成点对点通信任务。
* 为了达到去中心化目的，通信模块使用单纯型P2P技术。

### P2P技术概述
* P2P系统的分类
    * 混合型P2P
        >有专用的服务器，服务器作为索引服务器，混合型P2P系统中的索引服务器仅仅起到协调和扩展的功能，在索引服务器的协调下，各个设备间可进行P2P通信。</br>
        与C/S架构不同，C/S架构所有传递的信息都要经过服务器转发。
        * 混合型P2P通信原理简介
            1. 有一个拥有公网IP的节点——服务器，用来存储所有在线客户端的IP和端口信息。
            2. 每个客户端上线时，使用UDP向专用服务器发送一包数据，表示自己上线。
            3. 服务器记录客户端上线发送数据时所使用的IP和端口。
                >绝大部分情况下客户端在内网，当数据包经过出口路由时，路由上的NAT会修改数据包的发送方IP和端口修改为公网IP和随机端口，并在NAT上创建一个Session，该Session包含公网IP端口到客户端A IP口的映射</br>
                服务端记录的将是公网出口路由转发数据时使用的IP和端口，但因为路由NAT中Session的存在，给客户端公网IP和端口发送数据，路由会把数据转发给客户端A</br>
                这个Session是有时效性的，一般最小值大概在100秒左右。如果Session失效，路由接受到的数据包就是不经过认证的，一般的路由会做丢弃的操作。所以需要定时发送心跳包，让Session不失效。
            4. 当客户端A要与B通信时，客户端A从服务器获取客户端B的IP和端口信息，客户端A即可直接向客户端B发送数据，客户B也可直接给A发送数据，从而达到P2P通信。
            5. 参考图：![image](https://raw.githubusercontent.com/freemanpeng/VOS/master/images/Mixedp2p.png)
    * 单纯型P2P
        >没有专用的服务器，安装了P2P软件的各个设备可以直接通信。
* p2p通信的核心——网络打洞
    * .

### P2P的基本原理
* 混合型P2P
    * 发现阶段
    * 连接和通信
* 单纯型P2P
    * 发现阶段
    * 连接和通信
### P2P 通信模型及概念词
* 通信模型图
* 概念词
    *`VOS云`：所有接入网络的`VOS`节点，统称为`VOS云`。为表达方便，如果`VOS`没有连接网络，则称`VOS`不在`VOS云`。
    *`Friend VOS`：`VOS`用户可以指定N个`VOS`节点，作为自己的`Friend VOS`，对方同意后，建立起好友关系，互相给对方提供`VOS收件箱`服务。
        > 可验证:</br>
        一个应用场景举例：在系统用户量较少的情况下，用户可以购买一台硬件设备放置在某地，作为自己的其中一个`Friend VOS`，即可轻松保证`VOS收件箱`服务的的高可用。
    *`VOS收件箱`：是`Friend VOS`提供的一块存储空间。当你的`VOS`不在`VOS云`时，你的`Friend VOS`会替你接收信息，并保存。(其它`VOS`可选择使用你的公钥加密数据以保证数据安全)。
    *`Often Contact VOS`：与你经常联系的`VOS`，该信息由自己的`VOS`存储和使用，不需要共享给其它`VOS`。
### 模块需求
* 该模块需要在没有中心化服务器的前提下完成以下功能：
    * 每个`VOS`都有自己的`VOS收件箱`。
    * 加入`VOS云`时，通知`Friend VOS`和`Often Contact VOS`，并从自己的`VOS收件箱`中获取数据，并告知发送方`VOS收件箱`已读取。
    * 可以将数据发送到`VOS云`的任意`VOS节点`，并确认对方已收到。
    * 发送数据时，如果接收方不在`VOS云`，则将数据放入对方的`VOS收件箱`，并确定放入成功。
    * 对开发者提供API：
        * 判断指定地址是否在`VOS云`。
        * 与指定地址的`VOS`进行全双工传输。
### 设计模块
* 模块结构
* 模块流程
* .